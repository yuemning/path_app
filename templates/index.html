<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PATH Departures - Grove Street</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #f7f8fa;
            --card: #ffffff;
            --text: #101214;
            --muted: #6b7280;
            --border: #e5e7eb;
            --accent: #0f62fe;
            --urgent: #d92d20;
            --soon: #b54708;
            --normal: #107569;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px;
        }

        .container {
            max-width: 1100px;
            width: 100%;
            background: var(--card);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 10px 24px rgba(16, 18, 20, 0.06);
            border: 1px solid var(--border);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .station-name {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: 0.2px;
            color: var(--text);
            margin-bottom: 6px;
        }

        .last-updated {
            font-size: 0.95rem;
            color: var(--muted);
            margin-bottom: 18px;
        }

        .weather-info {
            background: #fafafa;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .weather-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .weather-icon {
            font-size: 1.25rem;
        }

        .weather-label {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .weather-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .departures-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 28px;
            margin-bottom: 8px;
        }

        .direction-section {
            padding: 4px;
        }

        .direction-section + .direction-section {
            border-left: 1px solid var(--border);
            padding-left: 28px;
        }

        .direction-title {
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
            text-align: left;
            margin-bottom: 10px;
        }

        .departures-grid {
            display: grid;
            gap: 10px;
        }

        .departure-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        }

        .departure-card:hover {
            background: #fcfcfd;
            box-shadow: 0 6px 16px rgba(16, 18, 20, 0.06);
            transform: translateY(-1px);
        }

        .departure-info {
            flex: 1;
            min-width: 0;
        }

        .destination {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .line-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex: 0 0 10px;
        }

        .arrival-time {
            font-variant-numeric: tabular-nums;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: right;
            min-width: 96px;
        }

        .arrival-time.urgent { color: var(--urgent); }
        .arrival-time.soon { color: var(--soon); }
        .arrival-time.normal { color: var(--normal); }

        .loading {
            text-align: center;
            font-size: 0.95rem;
            color: var(--muted);
            padding: 20px 0;
        }

        .error {
            text-align: center;
            color: var(--urgent);
            font-size: 0.95rem;
            padding: 14px;
            background: #fff1f1;
            border-radius: 10px;
            border: 1px solid #ffd2d2;
        }

        .refresh-indicator {
            position: fixed;
            top: 16px;
            right: 16px;
            background: #ffffff;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            color: var(--muted);
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(16, 18, 20, 0.06);
        }

        @media (max-width: 900px) {
            .container {
                padding: 22px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 18px;
            }

            .station-name {
                font-size: 1.6rem;
            }

            .departures-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .direction-section + .direction-section {
                border-left: none;
                padding-left: 4px;
            }

            .departure-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .arrival-time {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="refresh-indicator" id="refreshIndicator">
        üîÑ Auto-refresh: 30s
    </div>

    <div class="container">
        <div class="header">
            <h1 class="station-name">Grove Street Station</h1>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </div>

        <div class="weather-info" id="weatherContainer">
            <div class="weather-item">
                <div class="weather-icon" id="weatherIconNY">üå§Ô∏è</div>
                <div class="weather-label">Manhattan</div>
                <div class="weather-value" id="weatherTempNY">Loading...</div>
            </div>
            <div class="weather-item">
                <div class="weather-icon">üåÖ</div>
                <div class="weather-label">Sunrise</div>
                <div class="weather-value" id="sunriseTime">Loading...</div>
            </div>
            <div class="weather-item">
                <div class="weather-icon">üåá</div>
                <div class="weather-label">Sunset</div>
                <div class="weather-value" id="sunsetTime">Loading...</div>
            </div>
            <div class="weather-item">
                <div class="weather-icon" id="weatherIconJC">üå§Ô∏è</div>
                <div class="weather-label">Jersey City</div>
                <div class="weather-value" id="weatherTempJC">Loading...</div>
            </div>
        </div>

        <div class="departures-container" id="departuresContainer">
            <div class="direction-section">
                <div class="direction-title">NY PATH</div>
                <div class="departures-grid" id="nyDepartures">
                    <div class="loading">Loading departures...</div>
                </div>
            </div>
            <div class="direction-section">
                <div class="direction-title">NJ PATH</div>
                <div class="departures-grid" id="njDepartures">
                    <div class="loading">Loading departures...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;
        let countdownInterval;
        let nextRefresh = 30;

        function updateRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.textContent = `üîÑ Auto-refresh: ${nextRefresh}s`;
            
            if (nextRefresh <= 0) {
                nextRefresh = 30;
                fetchDepartures();
            } else {
                nextRefresh--;
            }
        }

        function getLineColor(colorString) {
            if (!colorString) return '#4CAF50';
            
            // Handle multiple colors (e.g., "4D92FB,FF9900")
            const colors = colorString.split(',');
            return `#${colors[0]}`;
        }

        function getArrivalTimeClass(arrivalTime, seconds) {
            if (arrivalTime.includes('Delayed')) return 'urgent';
            
            const secondsNum = parseInt(seconds);
            if (secondsNum <= 300) return 'urgent';  // 5 minutes or less
            if (secondsNum <= 600) return 'soon';    // 10 minutes or less
            return 'normal';
        }

        function formatDestination(headSign) {
            // Keep the full destination name but clean up minor formatting
            return headSign.replace('33rd Street', '33rd St');
        }

        function renderDepartures(data) {
            const nyContainer = document.getElementById('nyDepartures');
            const njContainer = document.getElementById('njDepartures');
            const lastUpdated = document.getElementById('lastUpdated');
            
            if (!data.departures || data.departures.length === 0) {
                nyContainer.innerHTML = '<div class="error">No departures</div>';
                njContainer.innerHTML = '<div class="error">No departures</div>';
                return;
            }

            lastUpdated.textContent = `Last updated: ${data.last_fetch}`;
            
            // Separate departures by direction
            const nyDepartures = data.departures.filter(d => d.direction === 'To New York');
            const njDepartures = data.departures.filter(d => d.direction === 'To New Jersey');
            
            function createDepartureHTML(departure) {
                return `
                    <div class="departure-card" style="border-left-color: ${getLineColor(departure.line_color)}">
                        <div class="departure-info">
                            <div class="destination">
                                <span class="line-indicator" style="background-color: ${getLineColor(departure.line_color)}"></span>
                                ${formatDestination(departure.destination)}
                            </div>
                        </div>
                        <div class="arrival-time ${getArrivalTimeClass(departure.arrival_time, departure.seconds_to_arrival)}">
                            ${departure.arrival_time}
                        </div>
                    </div>
                `;
            }
            
            nyContainer.innerHTML = nyDepartures.length > 0 ? 
                nyDepartures.map(createDepartureHTML).join('') : 
                '<div class="loading">No trains to NY</div>';
                
            njContainer.innerHTML = njDepartures.length > 0 ? 
                njDepartures.map(createDepartureHTML).join('') : 
                '<div class="loading">No trains to NJ</div>';
        }

        function fetchDepartures() {
            fetch('/api/departures')
                .then(response => response.json())
                .then(data => {
                    renderDepartures(data);
                })
                .catch(error => {
                    console.error('Error fetching departures:', error);
                    document.getElementById('nyDepartures').innerHTML = 
                        '<div class="error">Failed to load departures</div>';
                    document.getElementById('njDepartures').innerHTML = 
                        '<div class="error">Failed to load departures</div>';
                });
        }

        function fetchWeather() {
            fetch('/api/weather')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.log('Weather data not available');
                        return;
                    }
                    
                    if (data.jersey_city) {
                        document.getElementById('weatherTempJC').textContent = data.jersey_city.temperature_c;
                        document.getElementById('weatherIconJC').textContent = data.jersey_city.icon;
                    }
                    if (data.manhattan) {
                        document.getElementById('weatherTempNY').textContent = data.manhattan.temperature_c;
                        document.getElementById('weatherIconNY').textContent = data.manhattan.icon;
                    }
                    document.getElementById('sunriseTime').textContent = data.sunrise;
                    document.getElementById('sunsetTime').textContent = data.sunset;
                })
                .catch(error => {
                    console.error('Error fetching weather:', error);
                    document.getElementById('weatherTempJC').textContent = 'N/A';
                    document.getElementById('weatherTempNY').textContent = 'N/A';
                    document.getElementById('sunriseTime').textContent = 'N/A';
                    document.getElementById('sunsetTime').textContent = 'N/A';
                });
        }

        // Initialize
        fetchDepartures();
        fetchWeather();
        
        // Set up auto-refresh every 30 seconds for departures, every 5 minutes for weather
        refreshInterval = setInterval(fetchDepartures, 30000);
        setInterval(fetchWeather, 300000); // 5 minutes
        
        // Update countdown indicator every second
        countdownInterval = setInterval(updateRefreshIndicator, 1000);
        
        // Initial countdown setup
        updateRefreshIndicator();
    </script>
</body>
</html>
