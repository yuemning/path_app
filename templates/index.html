<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PATH Departures - Grove Street</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0b0f14;
            --card: #0f141a;
            --text: #e5e7eb;
            --muted: #9aa4b2;
            --border: #1f2937;
            --accent: #60a5fa;
            --urgent: #f97066;
            --soon: #f59e0b;
            --normal: #34d399;
            --scale: 1.15; /* global scale up */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 28px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: var(--card);
            border-radius: 16px;
            padding: 36px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
            border: 1px solid var(--border);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .station-name {
            font-size: calc(1.4rem * var(--scale));
            font-weight: 600;
            letter-spacing: 0.2px;
            color: var(--text);
            margin-bottom: 6px;
        }

        .last-updated {
            font-size: calc(1rem * var(--scale));
            color: var(--muted);
            margin-bottom: 22px;
        }

        .weather-info {
            background: #0b1117;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            text-align: center;
            margin-bottom: 24px;
        }

        .weather-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .weather-icon {
            font-size: calc(1.35rem * var(--scale));
        }

        .weather-label {
            font-size: calc(0.9rem * var(--scale));
            color: var(--muted);
        }

        .weather-value {
            font-size: calc(1.15rem * var(--scale));
            font-weight: 600;
        }

        .departures-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 12px;
        }

        .direction-section {
            padding: 4px;
        }

        .direction-section + .direction-section {
            border-left: 1px solid var(--border);
            padding-left: 28px;
        }

        .direction-title {
            font-size: calc(1rem * var(--scale));
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
            text-align: left;
            margin-bottom: 12px;
        }

        .departures-grid {
            display: grid;
            gap: 12px;
        }

        .departure-card {
            background: #0b1117;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        }

        .departure-card:hover {
            background: #0d131a;
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
            transform: translateY(-1px);
        }

        .departure-info {
            flex: 1;
            min-width: 0;
        }

        .destination {
            font-size: calc(1.1rem * var(--scale));
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .line-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex: 0 0 10px;
        }

        .arrival-time {
            font-variant-numeric: tabular-nums;
            font-size: calc(1.8rem * var(--scale));
            font-weight: 700;
            text-align: right;
            min-width: 110px;
        }

        .arrival-time.urgent { color: var(--urgent); }
        .arrival-time.soon { color: var(--soon); }
        .arrival-time.normal { color: var(--normal); }

        .loading {
            text-align: center;
            font-size: calc(1rem * var(--scale));
            color: var(--muted);
            padding: 22px 0;
        }

        .error {
            text-align: center;
            color: var(--urgent);
            font-size: calc(1rem * var(--scale));
            padding: 16px;
            background: rgba(217, 45, 32, 0.08);
            border-radius: 10px;
            border: 1px solid rgba(217, 45, 32, 0.22);
        }

        .refresh-indicator {
            position: fixed;
            top: 16px;
            right: 16px;
            background: #0f141a;
            padding: 10px 14px;
            border-radius: 999px;
            font-size: calc(0.95rem * var(--scale));
            color: var(--muted);
            border: 1px solid var(--border);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        }

        /* Countdown View */
        #countdownView { display: none; }
        .mode-countdown #countdownView { display: block; }
        .mode-countdown .departures-container { display: none; }
        .mode-countdown .weather-info { display: none; }
        .countdown-card {
            background: #0b1117;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px 40px;
            display: grid;
            gap: 18px;
            place-items: center;
            width: 100%;
        }
        .countdown-title {
            font-size: clamp(0.9rem, 1.6vw, 1.2rem);
            color: var(--muted);
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .countdown-time {
            font-variant-numeric: tabular-nums;
            font-size: clamp(3.5rem, 12vw, 12rem);
            font-weight: 800;
            letter-spacing: 1px;
        }
        .countdown-time.secondary {
            font-size: clamp(2rem, 6.5vw, 6rem);
            font-weight: 700;
            opacity: 0.9;
        }
        .countdown-subtle {
            font-size: clamp(0.9rem, 1.4vw, 1.1rem);
            color: var(--muted);
        }
        .countdown-row { display: grid; gap: 8px; place-items: center; }
        .countdown-label { font-size: calc(0.9rem * var(--scale)); color: var(--muted); }
        .countdown-time.red { color: #f97066; }
        .countdown-time.orange { color: #f59e0b; }
        .countdown-time.green { color: #34d399; }
        .countdown-time.blue { color: #60a5fa; }

        @media (max-width: 900px) {
            .container {
                padding: 26px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 22px;
            }

            .station-name {
                font-size: calc(1.8rem * var(--scale));
            }

            .departures-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .direction-section + .direction-section {
                border-left: none;
                padding-left: 4px;
            }

            .departure-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .arrival-time {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="refresh-indicator" id="refreshIndicator">
        üîÑ Auto-refresh: 30s
    </div>

    <div class="container">
        <div class="header">
            <h1 class="station-name">Grove Street Station</h1>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </div>

        <div class="weather-info" id="weatherContainer">
            <div class="weather-item">
                <div class="weather-icon" id="weatherIconNY">üå§Ô∏è</div>
                <div class="weather-label">Manhattan</div>
                <div class="weather-value" id="weatherTempNY">Loading...</div>
            </div>
            <div class="weather-item">
                <div class="weather-icon">üåÖ</div>
                <div class="weather-label">Sunrise</div>
                <div class="weather-value" id="sunriseTime">Loading...</div>
            </div>
            <div class="weather-item">
                <div class="weather-icon">üåá</div>
                <div class="weather-label">Sunset</div>
                <div class="weather-value" id="sunsetTime">Loading...</div>
            </div>
            <div class="weather-item">
                <div class="weather-icon" id="weatherIconJC">üå§Ô∏è</div>
                <div class="weather-label">Jersey City</div>
                <div class="weather-value" id="weatherTempJC">Loading...</div>
            </div>
        </div>

        <div class="departures-container" id="departuresContainer">
            <div class="direction-section">
                <div class="direction-title">NY PATH</div>
                <div class="departures-grid" id="nyDepartures">
                    <div class="loading">Loading departures...</div>
                </div>
            </div>
            <div class="direction-section">
                <div class="direction-title">NJ PATH</div>
                <div class="departures-grid" id="njDepartures">
                    <div class="loading">Loading departures...</div>
                </div>
            </div>
        </div>

        <div id="countdownView">
            <div class="countdown-card">
                <div class="countdown-title">World Trade Center Trains</div>
                <div class="countdown-row">
                    <div class="countdown-label">Next</div>
                    <div class="countdown-time" id="wtcCountdown1">--:--</div>
                    <div class="countdown-subtle" id="wtcEtaLabel1">Calculating‚Ä¶</div>
                </div>
                <div class="countdown-row">
                    <div class="countdown-label">Then</div>
                    <div class="countdown-time secondary" id="wtcCountdown2">--:--</div>
                    <div class="countdown-subtle" id="wtcEtaLabel2">Calculating‚Ä¶</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;
        let countdownInterval;
        let nextRefresh = 30;
        let latestDeparturesData = null;
        let isCountdownView = true;
        let departuresBaselineMs = null;

        function updateTick() {
            const indicator = document.getElementById('refreshIndicator');
            const mode = isCountdownView ? 'Countdown' : 'More Trains';
            indicator.textContent = `üîÑ ${mode} ‚Ä¢ Refresh in ${nextRefresh}s (press T to toggle)`;

            if (isCountdownView) updateWtcCountdown();

            if (nextRefresh <= 0) {
                nextRefresh = 30;
                fetchDepartures();
            } else {
                nextRefresh--;
            }
        }

        function getLineColor(colorString) {
            if (!colorString) return '#4CAF50';
            
            // Handle multiple colors (e.g., "4D92FB,FF9900")
            const colors = colorString.split(',');
            return `#${colors[0]}`;
        }

        function getArrivalTimeClass(arrivalTime, seconds) {
            if (arrivalTime.includes('Delayed')) return 'urgent';
            
            const secondsNum = parseInt(seconds);
            if (secondsNum <= 300) return 'urgent';  // 5 minutes or less
            if (secondsNum <= 600) return 'soon';    // 10 minutes or less
            return 'normal';
        }

        function formatDestination(headSign) {
            // Keep the full destination name but clean up minor formatting
            return headSign.replace('33rd Street', '33rd St');
        }

        function renderDepartures(data) {
            const nyContainer = document.getElementById('nyDepartures');
            const njContainer = document.getElementById('njDepartures');
            const lastUpdated = document.getElementById('lastUpdated');
            
            latestDeparturesData = data;
            departuresBaselineMs = Date.now();

            if (!data.departures || data.departures.length === 0) {
                nyContainer.innerHTML = '<div class="error">No departures</div>';
                njContainer.innerHTML = '<div class="error">No departures</div>';
                return;
            }

            lastUpdated.textContent = `Last updated: ${data.last_fetch}`;
            
            // Separate departures by direction
            const nyDepartures = data.departures.filter(d => d.direction === 'To New York');
            const njDepartures = data.departures.filter(d => d.direction === 'To New Jersey');
            
            function createDepartureHTML(departure) {
                return `
                    <div class="departure-card" style="border-left-color: ${getLineColor(departure.line_color)}">
                        <div class="departure-info">
                            <div class="destination">
                                <span class="line-indicator" style="background-color: ${getLineColor(departure.line_color)}"></span>
                                ${formatDestination(departure.destination)}
                            </div>
                        </div>
                        <div class="arrival-time ${getArrivalTimeClass(departure.arrival_time, departure.seconds_to_arrival)}">
                            ${departure.arrival_time}
                        </div>
                    </div>
                `;
            }
            
            nyContainer.innerHTML = nyDepartures.length > 0 ? 
                nyDepartures.map(createDepartureHTML).join('') : 
                '<div class="loading">No trains to NY</div>';
                
            njContainer.innerHTML = njDepartures.length > 0 ? 
                njDepartures.map(createDepartureHTML).join('') : 
                '<div class="loading">No trains to NJ</div>';
        }

        function findNextWtcSeconds(data) {
            if (!data || !data.departures) return null;
            const isWtc = (name) => {
                if (!name) return false;
                const n = name.toLowerCase();
                return n.includes('world trade');
            };
            const candidates = data.departures.filter(d => d.direction === 'To New York' && isWtc(d.destination));
            if (candidates.length === 0) return null;
            const elapsed = departuresBaselineMs ? Math.floor((Date.now() - departuresBaselineMs) / 1000) : 0;
            const sorted = candidates
                .map(d => parseInt(d.seconds_to_arrival))
                .filter(s => Number.isFinite(s))
                .map(base => Math.max(0, base - elapsed))
                .sort((a,b) => a-b);
            return sorted;
        }

        function colorForSeconds(seconds) {
            if (seconds < 120) return 'red';
            if (seconds < 300) return 'orange';
            if (seconds < 600) return 'green';
            return 'blue';
        }

        function updateWtcCountdown() {
            const list = findNextWtcSeconds(latestDeparturesData);
            const ids = [
                { time: 'wtcCountdown1', label: 'wtcEtaLabel1' },
                { time: 'wtcCountdown2', label: 'wtcEtaLabel2' }
            ];
            if (!list || list.length === 0) {
                ids.forEach(({time, label}) => {
                    document.getElementById(time).textContent = '--:--';
                    document.getElementById(label).textContent = 'No upcoming WTC train';
                    document.getElementById(time).classList.remove('red','orange','green','blue');
                });
                return;
            }
            ids.forEach(({time, label}, idx) => {
                const seconds = list[idx];
                const elTime = document.getElementById(time);
                const elLabel = document.getElementById(label);
                if (!Number.isFinite(seconds)) {
                    elTime.textContent = '--:--';
                    elLabel.textContent = 'No data';
                    elTime.classList.remove('red','orange','green','blue');
                    return;
                }
                const m = Math.max(0, Math.floor(seconds / 60));
                const s = Math.max(0, seconds % 60);
                elTime.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                elLabel.textContent = m === 0 ? 'Less than a minute' : `${m} min`;
                elTime.classList.remove('red','orange','green','blue');
                elTime.classList.add(colorForSeconds(seconds));
            });
        }

        function toggleView() {
            isCountdownView = !isCountdownView;
            document.body.classList.toggle('mode-countdown', isCountdownView);
            // Refresh countdown immediately when entering countdown mode
            if (isCountdownView) updateWtcCountdown();
        }

        function fetchDepartures() {
            fetch('/api/departures')
                .then(response => response.json())
                .then(data => {
                    renderDepartures(data);
                })
                .catch(error => {
                    console.error('Error fetching departures:', error);
                    document.getElementById('nyDepartures').innerHTML = 
                        '<div class="error">Failed to load departures</div>';
                    document.getElementById('njDepartures').innerHTML = 
                        '<div class="error">Failed to load departures</div>';
                });
        }

        function fetchWeather() {
            fetch('/api/weather')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.log('Weather data not available');
                        return;
                    }
                    
                    if (data.jersey_city) {
                        document.getElementById('weatherTempJC').textContent = data.jersey_city.temperature_c;
                        document.getElementById('weatherIconJC').textContent = data.jersey_city.icon;
                    }
                    if (data.manhattan) {
                        document.getElementById('weatherTempNY').textContent = data.manhattan.temperature_c;
                        document.getElementById('weatherIconNY').textContent = data.manhattan.icon;
                    }
                    document.getElementById('sunriseTime').textContent = data.sunrise;
                    document.getElementById('sunsetTime').textContent = data.sunset;
                })
                .catch(error => {
                    console.error('Error fetching weather:', error);
                    document.getElementById('weatherTempJC').textContent = 'N/A';
                    document.getElementById('weatherTempNY').textContent = 'N/A';
                    document.getElementById('sunriseTime').textContent = 'N/A';
                    document.getElementById('sunsetTime').textContent = 'N/A';
                });
        }

        // Initialize
        fetchDepartures();
        fetchWeather();
        
        // Set up auto-refresh every 30 seconds for departures, every 5 minutes for weather
        refreshInterval = setInterval(fetchDepartures, 30000);
        setInterval(fetchWeather, 300000); // 5 minutes
        
        // Update countdown indicator every second
        countdownInterval = setInterval(updateTick, 1000);
        
        // Initial countdown setup
        document.body.classList.add('mode-countdown');
        updateTick();

        // Keyboard toggle (T)
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                toggleView();
            }
        });
    </script>
</body>
</html>
